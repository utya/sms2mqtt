# CI: lint (Ruff) and tests (pytest). Uses uv (no pip).
image: python:3.11-slim

stages:
  - lint
  - test

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

default:
  interruptible: true
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv sync --extra dev

variables:
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"

cache:
  key:
    files:
      - uv.lock
      - sms2mqtt-persistence/uv.lock
  paths:
    - .cache/uv
  policy: pull-push

lint:
  stage: lint
  script:
    - uv run ruff check . --output-format=gitlab > gl-code-quality.json
    - uv run ruff format --check .
  artifacts:
    when: always
    reports:
      codequality: gl-code-quality.json

test:
  stage: test
  script:
    - uv run pytest tests/ -v --tb=short --junitxml=report.xml
    - cd sms2mqtt-persistence && uv sync --extra dev && uv run pytest tests/ -v --tb=short --junitxml=report-persistence.xml
  artifacts:
    when: always
    reports:
      junit:
        - report.xml
        - sms2mqtt-persistence/report-persistence.xml
