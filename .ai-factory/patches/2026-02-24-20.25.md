# Permission denied writing gammurc in Docker (non-root)

**Date:** 2026-02-24 20:25
**Files:** sms2mqtt.py, gammu_layer.py
**Severity:** high

## Problem

Container exited with code 1:
```
PermissionError: [Errno 13] Permission denied: '/app/gammurc'
  File "/app/gammu_layer.py", line 11, in write_gammurc
    with open(path, "w") as f:
```
Sms2mqtt runs as non-root user `appuser`; `/app` is owned by root, so creating a new file there fails.

## Root Cause

Dockerfile uses `USER appuser` and `COPY --chown=appuser:appuser` for app files. The working directory `/app` is created by root and stays root-owned. The process never wrote gammurc into a writable location â€” it used a hardcoded `/app/gammurc`, which requires write access to `/app`.

## Solution

- Use a writable path for the generated gammurc: `tempfile.gettempdir()` (e.g. `/tmp`) plus `gammurc` filename. Gammu only needs to read the file; the path is passed to `ReadConfig(Filename=...)`.
- In `sms2mqtt.py`: set `gammurc_path = os.path.join(tempfile.gettempdir(), "gammurc")`, added `import tempfile`, and a debug log `[FIX] Writing gammurc to writable path`.
- In `gammu_layer.write_gammurc`: added try/except with `[FIX]` logging on success (debug) and on OSError (error then re-raise).

## Prevention

- When running as non-root in Docker, never assume the app directory is writable for new files. Prefer `tempfile.gettempdir()` or a dedicated writable volume for generated config/cache.
- In Dockerfile comments or docs, note that the process creates gammurc in a writable location (e.g. /tmp).

## Tags

`#docker` `#permissions` `#non-root` `#gammurc` `#python`
