# Received SMS logged but not delivered to MQTT

**Date:** 2026-02-25 15:30
**Files:** mqtt_layer.py
**Severity:** high

## Problem

SMS messages (including multipart) appeared in container logs (e.g. "Received multipart SMS: ...") but were not visible on the MQTT topic `{prefix}/received`. Subscribers saw some messages (e.g. from "900") but not others (e.g. from "gosuslugi").

## Root Cause

Publish to `{prefix}/received` used default QoS 0. With QoS 0, paho-mqtt queues the message and sends it on the next `loop()`; if the connection drops or the client is busy before that, the message can be lost without any error. The code did not check the return value of `publish()` (e.g. `rc != 0` when not connected or queue full), and deleted the SMS from the modem after publishing, so failed deliveries were neither retried nor visible in logs.

## Solution

1. **QoS 1 for received** — Publish to `{prefix}/received` with `qos=1` so the broker acknowledges delivery and messages are not dropped silently on brief disconnect.
2. **Helper `_publish_received()`** — Centralized publish with return-value check; on `msg_info.rc != 0` or exception, log with `[FIX]` and return `False`.
3. **Delete only on success** — Delete SMS from the modem only when `_publish_received()` returns `True`, so failed publishes are retried on the next loop.
4. **Flush after publish** — Call `ctx.client.loop(timeout=0.1)` after a successful queue so the message is sent before continuing, reducing the window where a disconnect could lose it.

## Prevention

- For critical MQTT messages (e.g. received SMS), use QoS 1 and check `publish()` return value; only then delete or commit local state.
- Add tests that mock the client and assert publish is called with `qos=1` and that delete is skipped when publish returns non-zero `rc`.

## Tags

`#mqtt` `#qos` `#publish` `#reliability` `#sms` `#paho-mqtt`
