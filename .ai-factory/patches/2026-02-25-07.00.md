# paho-mqtt 2.x CallbackAPIVersion required

**Date:** 2026-02-25 07:00
**Files:** sms2mqtt.py, mqtt_layer.py, sms2mqtt-persistence/listener.py, tests/test_config_and_mqtt.py
**Severity:** high

## Problem

On startup sms2mqtt crashed with:
`ValueError: Unsupported callback API version: version 2.0 added a callback_api_version, see docs/migrations.rst for details`
when creating the MQTT client: `mqtt.Client(config.client_id)`.

## Root Cause

Project depends on `paho-mqtt>=2.0`. In 2.0 the library requires an explicit callback API version as the first argument to `Client()`. Passing only `client_id` made the library treat the string client_id as `callback_api_version`, which then failed the "is it a valid CallbackAPIVersion enum?" check and raised the error.

## Solution

1. **Client construction:** Use `mqtt.Client(mqtt.CallbackAPIVersion.VERSION2, config.client_id)` in sms2mqtt.py and the same pattern in sms2mqtt-persistence/listener.py.
2. **Callbacks (VERSION2 signatures):** Updated `on_mqtt_connect` to `(client, userdata, flags, reason_code, properties)` and `on_mqtt_disconnect` to `(client, userdata, disconnect_flags, reason_code, properties)`. For disconnect, reason code is taken via `getattr(reason_code, "value", reason_code)` so both enum and int work.
3. **Tests:** Adjusted test_config_and_mqtt.py to call `on_mqtt_disconnect` with five arguments (client, userdata, disconnect_flags, reason_code, properties).

## Prevention

- When upgrading paho-mqtt (or any dependency with a major bump), check release notes and migration docs.
- Pin or document minimum version and API (e.g. "paho-mqtt 2.x with CallbackAPIVersion.VERSION2") in README or DESCRIPTION.

## Tags

`#paho-mqtt` `#callback-api` `#compatibility` `#python`
