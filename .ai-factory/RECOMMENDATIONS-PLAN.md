# План рекомендаций по доработке sms2mqtt

Документ составлен по результатам просмотра кода, Docker, CI и README. Порядок блоков — по приоритету (критичное/важное → улучшения → опционально). Дорожную карту (roadmap) с вехами и сроками можно составить отдельно.

---

## 1. Критичные исправления

### 1.1 Баг: неопределённая переменная в обработчике MQTT

**Файл:** `sms2mqtt.py`, колбэк `on_mqtt_message`.

Если исключение возникает на этапе `msg.payload.decode("utf-8")` (например, невалидная UTF-8), переменная `payload` не присваивается, а в блоке `except` используется в `feedback["payload"]` → возможен `NameError`.

**Рекомендация:** в `except` не использовать `payload` до присвоения; брать сырые данные из `msg.payload` (например, repr или безопасно привести к строке) и только их класть в ответ.

---

### 1.2 Устаревший базовый образ и версия Python

**Файл:** `Dockerfile`.

- Базовый образ: `python:3.6.13-alpine3.12` — Python 3.6 уже EOL, образ старый.
- Риски: отсутствие обновлений безопасности, несовместимость с новыми зависимостями.

**Рекомендация:** перейти на актуальный Alpine и Python 3.11 или 3.12 (например, `python:3.11-alpine` или `python:3.12-alpine`), проверить работу с `gammu` и `paho-mqtt` в новом окружении.

---

## 2. Зависимости и воспроизводимость сборки

### 2.1 Фиксация версий Python-зависимостей

Сейчас зависимости ставятся в Dockerfile одной строкой без версий: `pip install python-gammu paho-mqtt certifi`. Сборки со временем могут разъехаться.

**Рекомендация:**

- Добавить `requirements.txt` (или `pyproject.toml`) с зафиксированными версиями (как минимум `python-gammu`, `paho-mqtt`, `certifi`).
- В Dockerfile установку делать через `pip install -r requirements.txt` (или из `pyproject.toml`), чтобы образ был воспроизводимым и обновления — контролируемыми.

---

## 3. Надёжность и поведение при сбоях

### 3.1 Выход из процесса при отключении MQTT

В `on_mqtt_disconnect` вызывается `exit()` — процесс завершается при любом разрыве связи с брокером. Для долгоживущего сервиса обычно предпочтительнее переподключение.

**Рекомендация:** не вызывать `exit()` в колбэке; либо использовать встроенный автоматический reconnect paho-mqtt (например, `client.reconnect()` в цикле или через `loop_start()` и повторные попытки), либо явный цикл переподключения с паузой и логированием. При необходимости оставить возможность «жёсткого» выхода через флаг/конфиг.

### 3.2 Уровень логирования

Уровень логирования зашит в коде: `logging.basicConfig(..., level=logging.INFO)`.

**Рекомендация:** вынести уровень в переменную окружения (например, `LOG_LEVEL`, по умолчанию `INFO`), задавать его при старте. Упростит отладку в проде без пересборки образа.

---

## 4. Безопасность и документация по ней

### 4.1 Документирование TLS и чувствительных переменных

В коде есть поддержка TLS (`USETLS`), в README она не описана. В README в примерах фигурируют PIN и пароль в открытом виде.

**Рекомендация:**

- В README добавить описание переменной `USETLS` (и при необходимости `DEVICE`) и предупреждение не подставлять реальные PIN/пароли в примеры; указать использование секретов (Docker secrets, env files не в репозитории).
- Кратко описать, что авторизация к действиям (отправка SMS, control) определяется только доступом к MQTT-топикам (ACL брокера); при необходимости — рекомендации по ограничению доступа к `send` и `control`.

### 4.2 Контроль доступа к топику control

Топик `control` (например, `delete_stuck_sms`) доступен всем, кто имеет право публиковать в него. Помимо MQTT ACL других проверок нет.

**Рекомендация:** оставить в плане как известное ограничение; при появлении требований к разграничению — добавить отдельный топик с ограниченным доступом или дополнительную проверку (например, секретный токен в payload). Пока достаточно явно описать в README.

---

## 5. Документация и консистентность

### 5.1 README: недостающие переменные и топики

В README не описаны:

- Переменные: `USETLS`, `DEVICE` (и при желании `DEVMODE`).
- Топики: `control` (формат payload, действие `delete_stuck_sms`), `control_response`, `stuck_status`.

**Рекомендация:** добавить в README раздел (или расширить существующий) с полным списком переменных окружения и перечнем топиков с форматом сообщений и назначением.

---

## 6. Тестирование и CI

### 6.1 Отсутствие тестов

В репозитории нет ни unit-, ни интеграционных тестов. Любые изменения (рефакторинг, обновление зависимостей) проверяются только вручную.

**Рекомендация:** на первом этапе добавить хотя бы минимальные unit-тесты: парсинг и валидация входящего JSON для `send` (валидные/невалидные number/text, отсутствующие поля, не UTF-8), формирование ответов об ошибках. Без реального MQTT и Gammu — только логика обработки сообщений. Это даст базу для рефакторинга и последующего добавления интеграционных тестов (например, с mock MQTT/модемом).

### 6.2 CI: линтер и тесты

Сейчас в CI есть CodeQL и публикация Docker-образов; отдельного шага с линтером (ruff/flake8) и запуском тестов нет.

**Рекомендация:** в GitHub Actions добавить job (или шаги): установка зависимостей, запуск тестов, при желании — линтер с жёстким fail при ошибках. Это предотвратит мерж сломанного кода.

### 6.3 Публикация dev-образа при каждом push

`docker-publish-dev.yml` срабатывает на любой `push`, без фильтра по ветке.

**Рекомендация:** ограничить триггер, например только веткой `dev` или `develop`, чтобы не плодить образы с каждого push в любую ветку.

---

## 7. Структура кода и архитектура

### 7.1 Глобальное состояние

Используются глобальные переменные: `client`, `gammusm`, `mqttprefix`, флаги для signal/battery/network и т.д. Это усложняет тестирование и возможное разбиение на модули.

**Рекомендация:** (низкий приоритет при текущем размере) при следующем рефакторинге вынести конфиг (prefix, host, port, use_tls и т.д.) в один объект/структуру и передавать его (или колбэки с замыканием) в функции, чтобы уменьшить зависимость от глобалов. Согласовано с `.ai-factory/ARCHITECTURE.md` (разделение слоёв).

### 7.2 Валидация и лимиты для number/text

Сейчас проверяется наличие и тип `number`/`text`; нормализации номера (E.164) и ограничения длины текста/номера нет. Очень длинный текст или некорректный номер могут приводить к неожиданному поведению Gammu или перегрузке.

**Рекомендация:** опционально добавить: нормализацию/очистку номера (например, только цифры и `+`), лимит длины текста (например, предупреждение или отказ при превышении разумного лимита). Детали можно зафиксировать в roadmap.

---

## 8. Операции и контейнер

### 8.1 Healthcheck в образе

В Dockerfile нет `HEALTHCHECK`. Оркестраторы (Docker Compose, Kubernetes) не могут автоматически считать контейнер нездоровым при «зависании» процесса.

**Рекомендация:** добавить в Dockerfile простой `HEALTHCHECK` (например, проверка процесса Python или лёгкая проверка внутри приложения, если появится HTTP/сигнальный эндпоинт). Минимальный вариант — проверка, что процесс жив (например, `pidof python` или аналог).

### 8.2 Блокирующий цикл и отзывчивость

Главный цикл: `time.sleep(1)` → `loop_sms_receive()` → `get_signal_info()` → … → `client.loop()`. Если `loop_sms_receive()` или вызовы Gammu надолго зависают, MQTT loop и остальные проверки задерживаются.

**Рекомендация:** оставить как известный компромисс; при появлении проблем с отзывчивостью рассмотреть вынос тяжёлых вызовов Gammu в отдельный поток/процесс или таймауты на уровне Gammu/драйвера. В roadmap можно отметить как возможное улучшение.

---

## 9. Сводная таблица

| №  | Категория        | Рекомендация                              | Приоритет   |
|----|------------------|--------------------------------------------|-------------|
| 1.1| Критичный баг    | Исправить использование `payload` в except | Высокий     |
| 1.2| Безопасность/обновления | Обновить Python и базовый образ Docker     | Высокий     |
| 2.1| Зависимости      | requirements.txt / pyproject.toml с версиями | Высокий   |
| 3.1| Надёжность       | Переподключение MQTT вместо exit()         | Средний     |
| 3.2| Конфиг           | LOG_LEVEL из env                           | Низкий      |
| 4.1| Документация     | README: USETLS, секреты, примеры           | Средний     |
| 4.2| Безопасность     | Документировать ограничения control        | Низкий      |
| 5.1| Документация     | README: все env и топики                   | Средний     |
| 6.1| Тесты            | Минимальные unit-тесты парсинга/валидации  | Средний     |
| 6.2| CI               | Job: тесты + линтер                         | Средний     |
| 6.3| CI               | Ограничить триггер dev-образа по ветке     | Низкий      |
| 7.1| Код              | Уменьшить глобальное состояние (при рефакторинге) | Низкий |
| 7.2| Валидация        | Нормализация номера, лимиты text           | Опционально |
| 8.1| Docker           | HEALTHCHECK в Dockerfile                   | Низкий      |
| 8.2| Поведение        | Отзывчивость при долгих вызовах Gammu      | Опционально |

---

Дальше можно составить **roadmap**: разнести пункты по этапам (например, «Стабилизация», «Безопасность и документация», «Тесты и CI», «Улучшения») и при желании оценить трудоёмкость и порядок выполнения.
